name: Desktop Build (Win + macOS)

on:
  workflow_dispatch:
    inputs:
      build_name:
        description: "building go go go"
        required: false
        type: string
  push:
    tags:
      - "v*"

env:
  PYTHONIOENCODING: utf-8
  PLAYWRIGHT_BROWSERS_PATH: 0
  APP_NAME: ${{ github.event.inputs.build_name || 'XianyuMonitor' }}

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: web-ui/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt pyinstaller

      - name: Install Playwright chromium
        run: python -m playwright install chromium

      - name: Build frontend
        working-directory: web-ui
        run: |
          npm ci
          npm run build

      - name: Copy frontend dist to backend
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
          Copy-Item -Recurse -Force web-ui/dist ./dist

      - name: Package desktop app (Windows)
        run: python scripts/package_desktop.py --name "${{ env.APP_NAME }}"

      - name: Archive artifact
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path packaged | Out-Null
          Compress-Archive -Path "dist/${{ env.APP_NAME }}.exe" -DestinationPath "packaged/${{ env.APP_NAME }}-windows.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows
          path: packaged/${{ env.APP_NAME }}-windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: web-ui/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt pyinstaller

      - name: Install Playwright chromium
        run: python -m playwright install chromium

      - name: Build frontend
        working-directory: web-ui
        run: |
          npm ci
          npm run build

      - name: Copy frontend dist to backend
        run: |
          rm -rf dist
          cp -r web-ui/dist ./dist

      - name: Package desktop app (macOS)
        run: python scripts/package_desktop.py --name "${{ env.APP_NAME }}"

      - name: Archive artifact
        run: |
          mkdir -p packaged
          tar -czf "packaged/${{ env.APP_NAME }}-macos.tar.gz" -C dist "${{ env.APP_NAME }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macos
          path: packaged/${{ env.APP_NAME }}-macos.tar.gz
