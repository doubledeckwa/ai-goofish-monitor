# Repository Guidelines

## Project structure and module organization
- The backend is located at `src/`，Entrance `src/app.py`，API Route in `src/api/routes/`，The service layer is `src/services/`，The domain model is in `src/domain/`，infrastructure in `src/infrastructure/`。
- The front end is in `web-ui/`（Vue 3 + Vite），view placed on `web-ui/src/views/`，The component is in `web-ui/src/components/`，The build product will be copied to the root directory `dist/`。
- The test is located at `tests/`，Naming follows `test_*.py` or `tests/*/test_*.py`。
- Operation data and resources：`prompts/`、`jsonl/`、`logs/`、`images/`、`static/`、`state/`，Configuration file `config.json` and `.env` Located in the root directory of the warehouse。

## Build, test and local development
- backend development：`python -m src.app` or `uvicorn src.app:app --host 0.0.0.0 --port 8000 --reload`。
- crawler task：`python spider_v2.py --task-name "MacBook Air M1" --debug-limit 3`（Available `--config` Specify custom configuration）。
- Front-end development：`cd web-ui && npm install && npm run dev`；build：`cd web-ui && npm run build`（Copy the product to the root directory `dist/`）。
- One-click local startup：`bash start.sh`（Automatically install dependencies, build front-end and start back-end）。
- Docker：`docker compose up --build -d`，View log `docker compose logs -f app`，stop `docker compose down`。

## Coding style and naming conventions
- stay layered：API → services → domain → infrastructure，Avoid cross-layer coupling and keep modules streamlined。
- Python The test function is named `test_*`，Files and paths follow the above test directory specifications.。
- Use descriptive, task-oriented naming（Such as crawler task name, configuration key），Corresponds to business meaning。

## Architecture and runtime
- Backend usage FastAPI supply API With static resources, crawlers and AI Inference collaborates in independent task processes, with front-end and back-end passing HTTP/Web UI interaction。
- The task will be run in `jsonl/` Write the result in `logs/` Keep running logs, in `images/` Download pictures, the front-end monitoring page relies on this data。
- Default listening 8000 Port, after the front-end is built, the static files can be generated by the back-end or Docker Mirror provided directly。

## Data Storage and Retrieval Architecture

### Product Data Flow
1. **Collection Layer:** scraper.py → parsers.py → JSONL files
2. **Processing Layer:** JsonProductRepository → ProductService → API  
3. **Presentation Layer:** FastAPI → Vue.js → User Interface

### Data Structure Standards
- **Format:** JSON Lines (JSONL) for streaming and memory efficiency
- **Location:** `jsonl/{task_name}_full_data.jsonl`
- **Backup:** Automatic deduplication by commodityID
- **Fields:** Product information, Seller information, AI analysis results

### Image Processing Pipeline
- **Collection:** All images from detail pages via `imageInfos` API field
- **Storage:** `images/task_{task_name}/` with deduplication
- **AI Processing:** Configurable limits (3 default for seller monitoring)
- **Display:** Main image + 4-column grid for additional images

## Anti-Blocking Strategies

### Current Implementation
- **Browser Fingerprinting:** Mobile UA anti-detection
- **Behavior Simulation:** Random delays, scrolls, natural navigation
- **Rotation System:** Account/proxy pools with TTL blacklisting
- **Detection:** baxia-dialog, J_MIDDLEWARE_FRAME_WIDGET, FAIL_SYS_USER_VALIDATE

### Enhanced Blocking Detection (when ENABLE_ADVANCED_BLOCKING=true)
- **Dynamic Selector Detection:** Pattern-based blocking element identification
- **Behavioral Analysis:** Anomaly detection in user interaction patterns
- **Network Monitoring:** Request/response pattern analysis
- **Smart Removal:** Automatic removal of blocking elements with fallback mechanisms

## Feature Toggle Framework

### Implementation Standards
- **Naming:** `ENABLE_FEATURE_NAME` environment variables
- **Defaults:** Backward compatible with existing configurations
- **Validation:** Type-safe configuration with Pydantic models
- **Hot Reload:** Runtime configuration updates without restart

### Current Toggle Features
- `ENABLE_USER_REGISTRATION` (default: true) - User registration control
- `ENABLE_USER_LOGIN` (default: true) - Authentication control
- `ENABLE_AI_ANALYSIS` (default: true) - AI processing control
- `ENABLE_AI_IMAGE_ANALYSIS` (default: true) - AI image processing control
- `ENABLE_ADVANCED_BLOCKING` (default: false) - Enhanced anti-blocking
- `ENABLE_PUBLIC_MARKETPLACE` (default: true) - Public API access
- `ENABLE_FAVORITES_SYSTEM` (default: true) - User favorites functionality

### Usage Examples
```bash
# Disable registration but keep login
ENABLE_USER_REGISTRATION=false
ENABLE_USER_LOGIN=true

# Enable enhanced blocking
ENABLE_ADVANCED_BLOCKING=true

# Disable AI for faster processing
ENABLE_AI_ANALYSIS=false
```

### Feature Toggle API
- `GET /api/admin/features/status` - Get all feature statuses (admin only)
- `GET /api/admin/features/check/{feature}` - Check specific feature (admin only)

## Testing Guide
- testing framework：`pytest`（Default synchronous test, no need `pytest-asyncio`）。
- Run all tests：`pytest`；Coverage：`pytest --cov=src` or `coverage run -m pytest`；Orientation test：`pytest tests/test_utils.py::test_safe_get`。
- Prioritize coverage of core services, exception branches and retry logic of crawler pipelines，avoid regression。
- PR Please run relevant tests before adding new logic to supplement targeted use cases.。

## Submit with PR specification
- Commit Adopt class Conventional Commits：`feat(...)`、`fix(...)`、`refactor(...)`、`chore(...)`、`docs(...)` wait。
- PR Need to explain the scope of change and impact modules；UI Changed in `web-ui/` Provide screenshots; link related Issue；Mention configuration or migration steps。

## Security and configuration tips
- copy `.env.example` for `.env`，Set required fields `OPENAI_API_KEY`、`OPENAI_BASE_URL`、`OPENAI_MODEL_NAME` wait。
- Do not submit real credentials or cookies（like `state.json`）；Playwright Requires local browser，Docker Image is pre-installed Chromium。
- Web Authentication default `admin/admin123`，The production environment must be modified and it is recommended to enable it. HTTPS and restrict access to sources。
